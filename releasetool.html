<!DOCTYPE HTML>
<html>
<head>
<title>Release tool</title>

<script type="text/javascript" src="lib/zip.js/WebContent/zip.js"></script>
<script>zip.useWebWorkers = false;</script>
<script type="text/javascript" src="lib/zip.js/WebContent/inflate.js"></script>
<script type="text/javascript" src="lib/zip.js/WebContent/deflate.js"></script>
<script type="text/javascript" src="lib/SparkMD5/spark-md5.js"></script>
<script type="text/javascript" src="lib/jquery-1.11.3.min.js"></script>
</head>

<body>
<header>Internal tool to simplify release hidden JSON creation</header>
<p><label><span class="form-label">choose a zip file</span><input type="file" accept=".zip,.litemod,.jar,application/zip" id="file-input" multiple="multiple"/></label></p>
<p><label>Loader / type<input type="text" id="loader" /></label></p>
<p><label>Forum comment link<input type="text" id="post" /></label></p>
<p><label>Installed minecraft version</label></p>
<p><select id="main-version">
<optgroup label="-- select --"><option disabled selected> -- </option></optgroup>
<optgroup label="Protocol 751"><option>1.16.2</option></optgroup>
<optgroup label="Protocol 736"><option>1.16.1</option></optgroup>
<optgroup label="Protocol 735"><option>1.16</option></optgroup>
<optgroup label="Protocol 578"><option>1.15.2</option></optgroup>
<optgroup label="Protocol 575"><option>1.15.1</option></optgroup>
<optgroup label="Protocol 573"><option>1.15</option></optgroup>
<optgroup label="Protocol 498"><option>1.14.4</option></optgroup>
<optgroup label="Protocol 490"><option>1.14.3</option></optgroup>
<optgroup label="Protocol 485"><option>1.14.2</option></optgroup>
<optgroup label="Protocol 480"><option>1.14.1</option></optgroup>
<optgroup label="Protocol 477"><option>1.14</option></optgroup>
<optgroup label="Protocol 404"><option>1.13.2</option></optgroup>
<optgroup label="Protocol 401"><option>1.13.1</option></optgroup>
<optgroup label="Protocol 393"><option>1.13</option></optgroup>
<optgroup label="Protocol 340"><option>1.12.2</option></optgroup>
<optgroup label="Protocol 338"><option>1.12.1</option></optgroup>
<optgroup label="Protocol 335"><option>1.12</option></optgroup>
<optgroup label="Protocol 316"><option>1.11.2</option><option>1.11.1</option></optgroup>
<optgroup label="Protocol 315"><option>1.11</option></optgroup>
<optgroup label="Protocol 210"><option>1.10.2</option><option>1.10.1</option><option>1.10</option></optgroup>
<optgroup label="Protocol 110"><option>1.9.4</option><option>1.9.3</option></optgroup>
<optgroup label="Protocol 109"><option>1.9.2</option></optgroup>
<optgroup label="Protocol 108"><option>1.9.1</option></optgroup>
<optgroup label="Protocol 107"><option>1.9</option></optgroup>
<optgroup label="Protocol 47"><option>1.8.9</option><option>1.8.8</option><option>1.8.7</option><option>1.8.6</option><option>1.8.5</option><option>1.8.4</option><option>1.8.3</option><option>1.8.2</option><option>1.8.1</option><option>1.8</option></optgroup>
<optgroup label="Protocol 5"><option>1.7.10</option><option>1.7.9</option><option>1.7.8</option><option>1.7.7</option><option>1.7.6</option></optgroup>
<optgroup label="Protocol 4"><option>1.7.5</option><option>1.7.4</option><option>1.7.3</option><option>1.7.2</option><option>1.7.1</option></optgroup></select></p>
<p><label>Supported minecraft versions (hold shift or control)</label></p>
<p><select id="supported-versions" size="23" multiple>
<optgroup label="-- select --"><option disabled selected> -- </option></optgroup>
<optgroup label="Protocol 751"><option>1.16.2</option></optgroup>
<optgroup label="Protocol 736"><option>1.16.1</option></optgroup>
<optgroup label="Protocol 735"><option>1.16</option></optgroup>
<optgroup label="Protocol 578"><option>1.15.2</option></optgroup>
<optgroup label="Protocol 575"><option>1.15.1</option></optgroup>
<optgroup label="Protocol 573"><option>1.15</option></optgroup>
<optgroup label="Protocol 498"><option>1.14.4</option></optgroup>
<optgroup label="Protocol 490"><option>1.14.3</option></optgroup>
<optgroup label="Protocol 485"><option>1.14.2</option></optgroup>
<optgroup label="Protocol 480"><option>1.14.1</option></optgroup>
<optgroup label="Protocol 477"><option>1.14</option></optgroup>
<optgroup label="Protocol 404"><option>1.13.2</option></optgroup>
<optgroup label="Protocol 401"><option>1.13.1</option></optgroup>
<optgroup label="Protocol 393"><option>1.13</option></optgroup>
<optgroup label="Protocol 340"><option>1.12.2</option></optgroup>
<optgroup label="Protocol 338"><option>1.12.1</option></optgroup>
<optgroup label="Protocol 335"><option>1.12</option></optgroup>
<optgroup label="Protocol 316"><option>1.11.2</option><option>1.11.1</option></optgroup>
<optgroup label="Protocol 315"><option>1.11</option></optgroup>
<optgroup label="Protocol 210"><option>1.10.2</option><option>1.10.1</option><option>1.10</option></optgroup>
<optgroup label="Protocol 110"><option>1.9.4</option><option>1.9.3</option></optgroup>
<optgroup label="Protocol 109"><option>1.9.2</option></optgroup>
<optgroup label="Protocol 108"><option>1.9.1</option></optgroup>
<optgroup label="Protocol 107"><option>1.9</option></optgroup>
<optgroup label="Protocol 47"><option>1.8.9</option><option>1.8.8</option><option>1.8.7</option><option>1.8.6</option><option>1.8.5</option><option>1.8.4</option><option>1.8.3</option><option>1.8.2</option><option>1.8.1</option><option>1.8</option></optgroup>
<optgroup label="Protocol 5"><option>1.7.10</option><option>1.7.9</option><option>1.7.8</option><option>1.7.7</option><option>1.7.6</option></optgroup>
<optgroup label="Protocol 4"><option>1.7.5</option><option>1.7.4</option><option>1.7.3</option><option>1.7.2</option><option>1.7.1</option></optgroup></select></p>
<p><label>Output</label><br><textarea readonly="readonly" id="release-description" placeholder="description will go after this text (edit this later)" style="width:100%; height:10em;"></textarea></p>
<p><span class="form-label">zip hashes</span>
<dl id="file-list"></dl>
</p>

<script>
//Adapted from https://raw.githubusercontent.com/gildas-lormeau/zip.js/gh-pages/demos/demo2.js
(function(obj) {
	"use strict";

	var versionInfoJson = {
		Loader: "",
		Post: "",
		Minecraft: "",
		MinecraftCompatible: [],
		Hashes: []
	};

	$("#loader").on("input", function() {
		versionInfoJson["Loader"] = $("#loader").val();
		updateTextBox();
	});
	$("#post").on("input", function() {
		versionInfoJson["Post"] = $("#post").val();
		updateTextBox();
	});
	$("#main-version").change(function() {
		versionInfoJson["Minecraft"] = $("#main-version").val();
		updateTextBox();
	});
	$("#supported-versions").change(function() {
		var supported = [];
		var el = $("#supported-versions")[0];
		for (var i = el.length - 1; i >= 0; i--) {
			console.log(el[i]);
			if (el[i].selected) {
				supported.push(el[i].value);
				console.log(supported);
			}
		}

		versionInfoJson["MinecraftCompatible"] = supported;

		console.log(supported);

		updateTextBox();
	});

	function onerror(message) {
		alert(message);
		console.log(message);
	}

	var model = (function() {
		return {
			getEntries : function(files, onend) {
				for (var i = 0; i < files.length; i++) {
					var file = files[i];
					zip.createReader(new zip.BlobReader(file), function(zipReader) {
						zipReader.getEntries(onend);
					}, onerror);
				}
			},
			getEntryBlob : function(entry, onend, onprogress) {
				var writer = new zip.BlobWriter();

				entry.getData(writer, function(blob) {
					onend(blob);
				}, onprogress);
			}
		};
	})();

	(function() {
		var fileInput = document.getElementById("file-input");
		var fileList = document.getElementById("file-list");

		var hashes = versionInfoJson["Hashes"] || [];

		function addHash(entry, dd, callback) {
			var unzipProgress = document.createElement("progress");

			model.getEntryBlob(entry, function(blobURL) {
				unzipProgress.value = 0;
				unzipProgress.max = 0;

				var fileReader = new FileReader();

				fileReader.onerror = function () {
					alert('Something went wrong with the file reader.');
				};

				fileReader.onloadend = function (e) {
					if (fileReader.result == null) {
						return;
					}

					var hash = SparkMD5.ArrayBuffer.hash(fileReader.result, false);
					dd.textContent = hash;

					if (entry.filename.indexOf("wdl") === 0 && entry.filename.indexOf(".") !== -1) {
						// Only include files starting with WDL
						// and that have a file extension.

						var path = entry.filename;
						var innerClassIndex = path.indexOf("$");
						var relativeTo;
						if (innerClassIndex !== -1) {
							// Start to first $
							relativeTo = path.substring(0, innerClassIndex);
						} else {
							// Full path minus trailing .class
							relativeTo = path.substring(0, path.lastIndexOf("."));
						}
						relativeTo = relativeTo.replace(/\//g, ".");

						// End of the package name.
						var classNameStart = relativeTo.lastIndexOf(".") + 1;

						// File name relative to the given class.
						var fileName = path.substring(classNameStart);

						var hashInfo = null;
						hashes.forEach(function(entry) {
							if (entry["RelativeTo"] == relativeTo && entry["File"] == fileName) {
								hashInfo = entry;
							}
						});

						if (!hashInfo) {
							hashInfo = {}
							hashInfo["Hash"] = [];
							hashes.push(hashInfo);
						}
						hashInfo["RelativeTo"] = relativeTo;
						hashInfo["File"] = fileName;
						if (hashInfo["Hash"].indexOf(hash) === -1) {
							hashInfo["Hash"].push(hash);
						}
					}

					callback();
				}

				fileReader.readAsArrayBuffer(blobURL);
			}, function(current, total) {
				unzipProgress.value = current;
				unzipProgress.max = total;
				dd.appendChild(unzipProgress);
			});
		}

		fileInput.addEventListener('change', function() {
			fileInput.disabled = true;
			model.getEntries(fileInput.files, function(entries) {
				fileList.innerHTML = "";

				var currentEntryNum = 0;

				var nextEntry = function() {
					if (currentEntryNum >= entries.length) {
						versionInfoJson["Hashes"] = hashes;

						fileInput.disabled = false;
						updateTextBox();
						return;
					}

					var entry = entries[currentEntryNum];
					currentEntryNum++;

					//Don't hash non-wdl code or otherwise volatile code.
					if (entry.filename.indexOf("wdl") == -1 ||
							entry.filename.indexOf("forge") != -1 ||
							entry.filename.indexOf("package-info") != -1 ||
							entry.filename.indexOf("Utils") != -1 ||
							entry.filename.indexOf("ShulkerBoxHandler") != -1 ||
							entry.filename.indexOf("NoteBlockHandler") != -1 ||
							entry.filename.indexOf("BaseLargeChestHandler") != -1 ||
							entry.filename.indexOf("TrappedChestHandler") != -1 ||
							entry.filename.indexOf("BarrelHandler") != -1 ||
							entry.filename.indexOf("BaseFurnaceHandler") != -1 || // This probably can be unignored later
							entry.filename.indexOf("BlastFurnaceHandler") != -1 ||
							entry.filename.indexOf("LecternHandler") != -1 ||
							entry.filename.indexOf("SmokerHandler") != -1 ||
							entry.filename.indexOf("GameRuleFunctions") != -1 || // For inner classes
							entry.filename.indexOf("IDimensionWrapper") != -1 ||
							entry.filename.indexOf("ISaveHandlerWrapper") != -1 ||
							entry.filename.indexOf("GeneratorFunctions") != -1 ||
							entry.filename.indexOf("HandlerFunctions") != -1 ||
							entry.filename.indexOf("data") != -1 ||
							entry.filename.indexOf("assets") != -1) {
						nextEntry();
						return;
					}

					var dt = document.createElement("dt");
					dt.textContent = entry.filename;
					var dd = document.createElement("dd");

					fileList.appendChild(dt);
					fileList.appendChild(dd);

					dd.textContent = "";

					addHash(entry, dd, nextEntry);
				}

				nextEntry();
			});
		}, false);
	})();

	function updateTextBox() {
		$("#release-description").val("[](# '" + JSON.stringify(versionInfoJson) + "')Type your description here...")
	}

	updateTextBox();
})(this);
</script>

</body>
</html>
